class Pacman{constructor(t){this.lastPos=vec.from(t),this.pos=vec.from(t),this.renderpos=vec.from(t),this.nt=vec.from(t),this.orientation=-1,this.nextOrientation=-1,this.animationTimer=0,this.pelletsEaten=0,this.ghostsEaten=0,this.points=0,this.level=0,this.lives=2,this.times1up=0,this.dead=!1,this.won=!1,this.lastPelletTime=Date.now(),this.pelletAud=[SFX.GetUnusedSource(!0),SFX.GetUnusedSource(!0)],this.pelletAud[0].src=this.pelletAud[1].src="./audio/pellet.wav",this.pelletAudIndex=0,this.nodraw=!1,this.readyText=!0,this.update=()=>{if(this.won){this.animationTimer--,this.animationTimer<=0&&(freeze=!1,start(this.level+1,!1));return}if(this.dead){this.animationTimer--,this.animationTimer<=0&&start(this.level,!0);return}if(this.points>highscore&&setCookie("pac-hs",(highscore=this.points).toString(),365),this.points-this.times1up*requiredFor1up>=requiredFor1up&&(this.times1up++,this.lives=Math.min(5,this.lives+1),SFX.GetUnusedSource().play("./audio/1up.wav")),244==this.pelletsEaten)return this.win();if(this.pos.equals(this.nt)?this.animationTimer=0:(this.animationTimer++,this.animationTimer%=8),this.renderpos.add(vec.from(this.nt).sub(this.pos).div(8)),!this.animationTimer){this.lastPos=vec.from(this.pos),this.pos=vec.from(this.nt),this.renderpos=vec.from(this.pos);let t=getTile(this.pos.x,this.pos.y);if(t)switch(t.type){case 45:t.changeTile(12,2),this.pelletsEaten++,this.points+=10,this.lastPelletTime=Date.now();var e=null;this.pelletAud[this.pelletAudIndex].playing?this.pelletAud[this.pelletAudIndex].elapsed>.25&&(this.pelletAudIndex=1-this.pelletAudIndex,e=this.pelletAud[this.pelletAudIndex]):e=this.pelletAud[this.pelletAudIndex],e&&(e.playing&&e.stop(),e.play());break;case 47:for(let i of(t.changeTile(12,2),this.pelletsEaten++,this.points+=50,this.lastPelletTime=Date.now(),ghosts))i.eaten||i.spawnloop||i.changeMode(3);this.ghostsEaten=0,siren.playing&&siren.stop(),siren.loop("./audio/frightened.wav")}let s=this.orientation;this.orientation=this.nextOrientation;let n=new vec().setVals(this.orientation).add(this.pos),a=getTile(n.x,n.y);if(!a||acceptableTiles.includes(a.type))this.nt=n;else{this.orientation=s;let o=new vec().setVals(this.orientation).add(this.pos),r=getTile(o.x,o.y);(!r||acceptableTiles.includes(r.type))&&(this.nt=o)}}this.renderpos.x>w/8-1?(this.pos.x=0,this.nt.x=1):this.renderpos.x<=0&&(this.pos.x=w/8,this.nt.x=w/8-1)},this.die=()=>{for(let t of(this.animationTimer=90,this.dead=!0,ghosts))t.nodraw=!0;SFX.GetUnusedSource().play("./audio/death.wav"),siren.playing&&siren.stop()},this.win=()=>{this.animationTimer=150,this.won=!0,freeze=!0},this.requestOrientationChange=t=>{this.nextOrientation=t},this.render=t=>{if(!this.nodraw){if(this.dead){ctx.drawImage(spritesheet,35+(14-Math.round(this.animationTimer/90*14))*16,28,14,16,8*this.renderpos.x-3,8*this.renderpos.y-3,14,16);return}this.readyText&&ctx.drawImage(spritesheet,0,506,46,7,91,163,46,7),this.orientation<0?ctx.drawImage(spritesheet,35,28,14,16,8*this.renderpos.x+1,8*this.renderpos.y-3,14,16):ctx.drawImage(spritesheet,!(t%8>4)||this.nt.equals(this.pos)&&this.pos.equals(this.renderpos)?19:3,16*this.orientation+28,14,16,8*this.renderpos.x-3,8*this.renderpos.y-3,14,16),ctx.drawImage(spritesheet,0,174+16*Math.min(this.level,18),111,16,w-112,h-16,111,16),this.lives&&ctx.drawImage(spritesheet,112,174+16*(5-Math.min(this.lives,5)),80,16,1,h-16,80,16),drawNumbers(this.points,48,8),drawNumbers(highscore.toString().padStart(6,"0"),128,8),ctx.drawImage(spritesheet,139,255,126,7,26,0,126,7)}},this.handleKeyPress=t=>{switch(t.key.toLowerCase()){case"w":case"arrowup":this.requestOrientationChange(2);break;case"a":case"arrowleft":this.requestOrientationChange(1);break;case"s":case"arrowdown":this.requestOrientationChange(3);break;case"d":case"arrowright":this.requestOrientationChange(0)}},this.mobileSwipeLast=new vec,this.handleSwipe=t=>{if(t instanceof MouseEvent){if(t.button||t.buttons){let e=t.movementX,i=t.movementY;Math.abs(e)>Math.abs(i)?e>0?this.requestOrientationChange(0):this.requestOrientationChange(1):i>0?this.requestOrientationChange(3):this.requestOrientationChange(2)}}else if(t instanceof TouchEvent){let s=t.touches[t.touches.length-1].clientX,n=t.touches[t.touches.length-1].clientY,a=s-this.mobileSwipeLast.x,o=n-this.mobileSwipeLast.y;Math.abs(a)>Math.abs(o)?a>0?this.requestOrientationChange(0):this.requestOrientationChange(1):o>0?this.requestOrientationChange(3):this.requestOrientationChange(2),this.mobileSwipeLast=new vec(s,n)}else throw TypeError("Unknown Swipe Source")},window.addEventListener("keydown",t=>this.handleKeyPress(t)),window.addEventListener("touchmove",t=>this.handleSwipe(t)),window.addEventListener("mousemove",t=>this.handleSwipe(t))}}