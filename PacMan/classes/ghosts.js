class Ghost{constructor(t,s,e){this.pos=vec.from(s),this.renderpos=vec.from(s),this.nt=vec.from(s),this.target=new vec,this.lastPos=vec.from(s),this.type=~~t,this.orientation=0,this.animationTimer=0,this.scatterTarget=vec.from(e),this.spawnloop=!0,this.chase=!1,this.scatter=!1,this.frightened=!1,this.eaten=!1,this.previousScatter=!0,this.frightenedTimer=0,this.wave=0,this.waveTimer=waves[Math.min(player.level,4)][this.wave],this.drawEatenNumber=!1,this.nodraw=!1,this.update=t=>{if(this.nodraw)return;if(this.waveTimer--,this.eaten)this.target=new vec(14,16),s=!0,this.pos.equals(new vec(14,16))&&(this.lastPos=vec.from(this.pos),this.changeMode(0));else if(this.frightened)this.frightenedTimer--,this.target=new vec(random(-1e3,1e3),random(-1e3,1e3)),this.frightenedTimer<=0&&(siren.audio.src.includes("frightened.wav")&&(siren.stop(),siren.loop("./audio/siren.wav")),this.changeMode(this.previousScatter+1));else if(this.scatter)this.target=vec.from(this.scatterTarget),this.waveTimer<=0&&(this.wave++,this.waveTimer=waves[Math.min(player.level,4)][this.wave],this.previousScatter=!1,this.changeMode(1));else if(this.chase)this.target=this.getTarget(),this.waveTimer<=0&&(this.wave++,this.waveTimer=waves[Math.min(player.level,4)][this.wave],this.previousScatter=!0,this.changeMode(2));else if(this.spawnloop){if(!(player.pelletsEaten>=this.spawnPelletsRequire[Math.min(player.level,this.spawnPelletsRequire.length-1)]||Date.now()-player.lastPelletTime>5e3&&!ghosts[this.type-1].spawnloop))return this.orientation=~~(t/30)%4;this.pos.equals(new vec(14,14))?(player.lastPelletTime=Date.now(),this.lastPos=vec.from(this.pos),this.changeMode(this.previousScatter+1)):this.target=new vec(14,14)}else throw Error("No Ghost mode");var s,e=this.frightened||17==this.pos.y&&(this.pos.x<6||this.pos.x>21);this.pos.equals(this.nt)?this.animationTimer=0:(this.animationTimer+=e?.5:s?2:1,this.animationTimer%=8);let i=vec.from(this.nt).sub(this.pos).div(8);if(e?i.div(2):s&&i.mult(2),this.renderpos.add(i),!this.animationTimer){this.lastPos=vec.from(this.pos),this.pos=vec.from(this.nt),this.renderpos=vec.from(this.pos);let r=[new vec(0,-1).add(this.pos),new vec(-1,0).add(this.pos),new vec(0,1).add(this.pos),new vec(1,0).add(this.pos)];r=r.sort((t,s)=>t.distance(this.target)-s.distance(this.target));for(let n=0;n<r.length;++n){let a=getTile(r[n].x,r[n].y);if(!r[n].equals(this.lastPos)&&(!a||acceptableTiles.includes(a.type)||this.pos.equals(new vec(14,16))&&r[n].equals(new vec(14,15))||this.eaten&&this.pos.equals(new vec(14,14))&&r[n].equals(new vec(14,15)))){this.orientation=r[n].sub(this.pos).getOrientation();break}}this.nt=new vec().setVals(this.orientation).add(this.pos)}this.renderpos.x>w/8-1?(this.pos.x=0,this.nt.x=1):this.renderpos.x<=0&&(this.pos.x=w/8,this.nt.x=w/8-1),this.checkCollision()},this.changeMode=t=>{let s=[this.spawnloop,this.chase,this.scatter,this.frightened,this.eaten];switch(this.spawnloop=this.chase=this.scatter=this.frightened=this.eaten=!1,t){case 0:this.spawnloop=!0;break;case 1:this.chase=!0;break;case 2:this.scatter=!0;break;case 3:this.frightened=!0,this.frightenedTimer=420;break;case 4:this.eaten=!0}if(!s[t]){this.animationTimer=0,this.renderpos=vec.from(this.pos);let e=vec.from(this.nt);this.nt=vec.from(this.lastPos),this.lastPos=e}},this.checkCollision=()=>{let t=.2;player.renderpos.x-t>this.renderpos.x+t||player.renderpos.x+t<this.renderpos.x-t||player.renderpos.y-t>this.renderpos.y+t||player.renderpos.y+t<this.renderpos.y-t||(this.frightened?(freeze=!0,player.nodraw=!0,player.ghostsEaten++,SFX.GetUnusedSource().play("./audio/ghostDeath.wav",()=>{freeze=!1,player.nodraw=!1,this.drawEatenNumber=0}),this.changeMode(4),this.drawEatenNumber=player.ghostsEaten,player.points+=[200,400,800,1600][player.ghostsEaten-1]):this.eaten||player.die())},this.render=t=>{if(!this.nodraw){if(this.drawEatenNumber)return ctx.drawImage(spritesheet,270+(player.ghostsEaten-1)*16,102,15+(4==player.ghostsEaten),7,8*this.renderpos.x,8*this.renderpos.y,15+(4==player.ghostsEaten),7);this.eaten?ctx.drawImage(spritesheet,14*this.orientation+2*this.orientation+129,124,14,14,8*this.renderpos.x-3,8*this.renderpos.y-3,14,14):this.frightened?ctx.drawImage(spritesheet,16*(t%8>4)+(this.frightenedTimer<180&&t%30>15?160:128),108,14,14,8*this.renderpos.x-3,8*this.renderpos.y-3,14,14):ctx.drawImage(spritesheet,28*this.orientation+4*this.orientation+16*(t%8>4),14*this.type+2*this.type+108,14,14,8*this.renderpos.x-3+(this.spawnloop?-4:0),8*this.renderpos.y-3,14,14)}},this.getTarget=()=>vec.from(this.pos),ghosts.push(this)}}class Blinky extends Ghost{constructor(){super(0,new vec(14,14),new vec(w/8-1,0)),this.spawnPelletsRequire=[0,0],this.getTarget=()=>vec.from(player.pos)}}class Pinky extends Ghost{constructor(){super(1,new vec(14,17),new vec(0,0)),this.spawnPelletsRequire=[30,0],this.getTarget=()=>new vec().setVals(player.orientation).mult(4).add(player.pos)}}class Inky extends Ghost{constructor(){super(2,new vec(12,17),new vec(w/8-1,h/8-1)),this.spawnPelletsRequire=[50,10],this.getTarget=()=>{let t=new vec().setVals(player.orientation).mult(2).add(player.pos),s=vec.from(ghosts[0].pos).sub(t),e=-1,i=12246467991473532e-32;return new vec(~~(s.x*e-s.y*i),~~(s.x*i+s.y*e)).add(t)}}}class Clyde extends Ghost{constructor(){super(3,new vec(16,17),new vec(0,h/8-1)),this.spawnPelletsRequire=[60,50],this.getTarget=()=>this.pos.distance(player.pos)/8<8?vec.from(this.scatterTarget):vec.from(player.pos)}}